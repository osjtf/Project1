<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Multimedia Guidance — NextStep Navigator</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <style>
    :root{
      --brand:#5b7cff; --brand2:#0ea5e9; --ink:#0f172a; --muted:#667085; --ring:#e5e7eb; --card:#fff; --surface:#f8fafc;
    }
    body{background:var(--surface); color:var(--ink)}
    a{text-decoration:none}
    .navbar{background:#fff}
    .brand-dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .page-head{background:#fff;border-bottom:1px solid #eef2f7}
    .lead-muted{color:var(--muted)}
    .panel{background:#fff;border:1px solid var(--ring);border-radius:18px}
    .feature-card{border:1px solid var(--ring);background:var(--card);border-radius:16px;transition:all .25s ease}
    .feature-card:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(16,24,40,.07);border-color:rgba(91,124,255,.4)}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .6rem;border:1px solid var(--ring);border-radius:999px;background:#fff;font-size:.8rem}
    .chip{display:inline-flex;gap:.4rem;align-items:center;border:1px solid var(--ring);border-radius:999px;padding:.25rem .6rem;background:#fff;font-size:.8rem}
    .thumb{position:relative;aspect-ratio:16/9;background:#e5e7eb;border-radius:12px;overflow:hidden}
    .thumb iframe{width:100%;height:100%;border:0}
    .meta{font-size:.85rem;color:var(--muted)}
    .bookmark-active{color:#e11d48 !important}
    .hidden{display:none !important}
    .result-skel{height:260px;border:1px dashed #e5e7eb;border-radius:16px;animation:pulse 1.2s ease-in-out infinite;background:linear-gradient(90deg,#fff 25%,#f4f6f8 37%,#fff 63%)}
    @keyframes pulse{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}
    .transcript{white-space:pre-wrap; font-size:.92rem}
    .icon-pill{width:42px;height:42px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#eef2ff;color:#3b82f6}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg border-bottom sticky-top">
    <div class="container py-2">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="index.html">
        <span class="brand-dot"></span> NextStep <span class="text-primary">Navigator</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="small text-muted" id="helloUser"></span>
        <a class="btn btn-outline-secondary btn-sm" href="index.html"><i class="bi bi-house me-1"></i> Home</a>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="page-head py-4">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Multimedia</li>
        </ol>
      </nav>
      <div class="d-flex flex-column flex-md-row align-items-md-end align-items-start justify-content-between gap-3">
        <div>
          <h1 class="mb-1">Multimedia Guidance</h1>
          <p class="lead lead-muted mb-0">Curated videos & podcasts for students, graduates, and professionals — loaded from JSON.</p>
        </div>
        <span class="pill"><i class="bi bi-shield-check"></i> Privacy: YouTube nocookie embeds</span>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="py-4">
    <div class="container">
      <div class="row g-4">
        <!-- Filters -->
        <aside class="col-lg-3">
          <div class="panel p-3">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0">Filters</h6>
              <button class="btn btn-link btn-sm" id="btnClear">Clear</button>
            </div>
            <hr/>

            <div class="mb-3">
              <label class="form-label mb-1">Search</label>
              <input type="search" id="search" class="form-control" placeholder="Title, speaker, tags…"/>
            </div>

            <div class="mb-3">
              <label class="form-label mb-1">User Type</label>
              <select id="userTypeFilter" class="form-select">
                <option value="">All</option>
                <option value="student">Student</option>
                <option value="graduate">Graduate</option>
                <option value="professional">Professional</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label mb-1">Category</label>
              <select id="categoryFilter" class="form-select">
                <option value="">All</option>
                <option value="motivation">Motivation</option>
                <option value="roles">Job Roles</option>
                <option value="internships">Internships</option>
                <option value="skills">Skills</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label mb-1">Format</label>
              <select id="formatFilter" class="form-select">
                <option value="">All</option>
                <option value="video">Video</option>
                <option value="podcast">Podcast</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label mb-1">Sort by</label>
              <select id="sortBy" class="form-select">
                <option value="newest">Newest → Oldest</option>
                <option value="oldest">Oldest → Newest</option>
                <option value="az">Title A → Z</option>
                <option value="za">Title Z → A</option>
              </select>
            </div>

            <div class="mb-0">
              <label class="form-label mb-1">Items per page</label>
              <select id="perPage" class="form-select">
                <option>6</option>
                <option selected>9</option>
                <option>12</option>
                <option>15</option>
              </select>
            </div>
          </div>

          <div class="panel p-3 mt-3">
            <h6>Recently Viewed</h6>
            <ul id="recentList" class="list-unstyled small mb-0">
              <li class="text-muted">Nothing yet.</li>
            </ul>
          </div>

          <div class="panel p-3 mt-3">
            <h6>Your Bookmarks</h6>
            <ul id="bookmarkList" class="list-unstyled small mb-2">
              <li class="text-muted">No bookmarks yet.</li>
            </ul>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" id="exportBookmarks"><i class="bi bi-arrow-down-square me-1"></i> Export</button>
              <button class="btn btn-outline-danger btn-sm" id="clearBookmarks"><i class="bi bi-trash3 me-1"></i> Clear</button>
            </div>
          </div>
        </aside>

        <!-- Results -->
        <section class="col-lg-9">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="small text-muted" id="resultCount">Loading…</div>
            <div class="small text-muted" id="activeProfile"></div>
          </div>

          <div id="skeleton" class="row g-3">
            <div class="col-12 col-md-6"><div class="result-skel"></div></div>
            <div class="col-12 col-md-6"><div class="result-skel"></div></div>
            <div class="col-12 col-md-6"><div class="result-skel"></div></div>
          </div>

          <div id="grid" class="row g-3 hidden"></div>

          <nav class="d-flex align-items-center justify-content-between mt-3" aria-label="Pagination">
            <div class="small text-muted" id="pageInfo"></div>
            <ul class="pagination mb-0">
              <li class="page-item"><button class="page-link" id="prevPage">Prev</button></li>
              <li class="page-item"><button class="page-link" id="nextPage">Next</button></li>
            </ul>
          </nav>
        </section>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="py-4 border-top bg-white">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
      <div class="small text-muted">© <span id="year"></span> NextStep Navigator • Multimedia</div>
      <div class="small"><a href="about.html" class="me-3">About</a><a href="contact.html">Contact</a></div>
    </div>
  </footer>
<script src="js/nsn-shared.js"></script>
<script src="js/quiz.js"></script>           <!-- page-specific -->
<!-- or -->
<script src="js/multimedia.js"></script>     <!-- page-specific -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
/******************************
 * NextStep Navigator — Multimedia
 * JSON-driven (data/multimedia.json) with NSN shared module
 ******************************/

const DATA_URL = 'data/multimedia.json';

const $  = NSN.utils.$;
const $$ = NSN.utils.$$;
const toDate     = (s) => new Date(s);
const capitalize = (s='') => s.charAt(0).toUpperCase() + s.slice(1);
const esc        = (s) => NSN.utils.escapeHTML(s);

/******** Personalization header ********/
function paintHeaderProfile(){
  const nm = sessionStorage.getItem('nsn_name') || '';
  const tp = (sessionStorage.getItem('nsn_type') || '');
  const helloEl  = $('#helloUser');
  const activeEl = $('#activeProfile');
  if (helloEl)  helloEl.textContent  = (nm || tp) ? `Hi ${nm ? nm : ''}${nm && tp ? ' • ' : ''}${tp ? tp[0].toUpperCase()+tp.slice(1) : ''}` : '';
  if (activeEl) activeEl.textContent = tp ? `Tailored for: ${tp}` : '';

  // Prefill the filter to match user type once (init() will read value into state)
  const sel = $('#userTypeFilter');
  if (tp && sel && !sel.value) sel.value = tp;
}

/******** Data & State ********/
let ITEMS = []; // normalized items from multimedia.json
const state = { q:'', ut:'', cat:'', fmt:'', sort:'newest', page:1, perPage:9 };

/******** Normalize JSON to avoid filter mismatches ********/
function normalizeItems(rows){
  return (rows||[]).map(it=>{
    const norm = {
      ...it,
      userType: (it.userType||'').toLowerCase().trim(),
      category: (it.category||'').toLowerCase().trim(),
      format:   (it.format||'').toLowerCase().trim(),
      date:     it.date || '2000-01-01'
    };
    if (!norm.id) norm.id = `auto-${Math.random().toString(36).slice(2)}`; // Ensure item has an id
    return norm;
  });
}

/******** Card renderer ********/
function itemCard(item){
  const bmActive = NSN.isBookmarked(item.id) ? 'bookmark-active' : '';
  const tags = (item.tags||[]).map(t=>`<span class="chip"><i class="bi bi-tag"></i> ${esc(t)}</span>`).join(' ');

  const media = item.format === 'video' && item.youtubeId
    ? `<div class="thumb"><iframe loading="lazy" title="${esc(item.title)}"
         src="https://www.youtube-nocookie.com/embed/${encodeURIComponent(item.youtubeId)}"
         allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
         referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe></div>`
    : (item.format === 'podcast' && item.audioUrl
      ? `<audio controls class="w-100" preload="none" src="${esc(item.audioUrl)}"></audio>`
      : `<div class="thumb d-flex align-items-center justify-content-center text-muted">No media</div>`);

  return `
    <div class="col-12 col-md-6 col-xl-4">
      <article class="feature-card p-3 h-100 d-flex flex-column">
        <div class="d-flex align-items-start justify-content-between mb-2">
          <div class="icon-pill"><i class="bi ${item.icon||'bi-camera-reels'}"></i></div>
          <button class="btn btn-light btn-sm border-0 ${bmActive}" title="Bookmark"
                  data-bm="${item.id}" data-label="${esc(item.title)}"
                  data-href="${item.format==='video'&&item.youtubeId ? `https://www.youtube.com/watch?v=${encodeURIComponent(item.youtubeId)}` : (item.audioUrl||'#')}">
            <i class="bi bi-heart-fill"></i>
          </button>
        </div>
        <h6 class="mb-1">${esc(item.title)}</h6>
        <div class="meta mb-2">
          <i class="bi bi-person-video3 me-1"></i>${esc(item.speaker||'—')}
          · <i class="bi bi-collection-play me-1"></i>${capitalize(item.category)}
          · <i class="bi bi-people me-1"></i>${capitalize(item.userType)}
          · <i class="bi bi-calendar-event me-1"></i>${new Date(item.date).toLocaleDateString()}
        </div>
        ${media}
        <p class="small muted mt-2 mb-2">${esc(item.description||'')}</p>
        <div class="d-flex flex-wrap gap-1 mb-2">${tags}</div>

        <div class="mt-auto">
          <div class="d-flex flex-wrap gap-2">
            ${item.format==='video' && item.youtubeId ? `<a class="btn btn-outline-primary btn-sm" target="_blank" rel="noreferrer" href="https://www.youtube.com/watch?v=${encodeURIComponent(item.youtubeId)}"><i class="bi bi-box-arrow-up-right me-1"></i> Open on YouTube</a>` : ''}
            ${item.format==='podcast' && item.audioUrl ? `<a class="btn btn-outline-primary btn-sm" target="_blank" rel="noreferrer" href="${esc(item.audioUrl)}"><i class="bi bi-box-arrow-up-right me-1"></i> Open audio</a>` : ''}
            ${item.transcript ? `<button class="btn btn-light btn-sm" data-tx="${item.id}"><i class="bi bi-text-paragraph me-1"></i> Transcript</button>` : ''}
          </div>
          <div class="mt-2 transcript hidden" id="tx-${item.id}">${esc(item.transcript||'')}</div>
        </div>
      </article>
    </div>`;
}

/******** Filtering, sorting, paging ********/
function applyFilters(){
  const q = state.q.trim().toLowerCase();
  let rows = ITEMS.filter(it=>{
    const text = `${it.title||''} ${it.speaker||''} ${(it.tags||[]).join(' ')} ${it.description||''}`.toLowerCase();
    const matchesQ   = !q || text.includes(q);
    const matchesUT  = !state.ut  || (it.userType === state.ut);
    const matchesCat = !state.cat || (it.category === state.cat);
    const matchesFmt = !state.fmt || (it.format === state.fmt);
    return matchesQ && matchesUT && matchesCat && matchesFmt;
  });

  rows.sort((a,b)=>{
    switch(state.sort){
      case 'newest': return toDate(b.date) - toDate(a.date);
      case 'oldest': return toDate(a.date) - toDate(b.date);
      case 'az':     return (a.title||'').localeCompare(b.title||'');
      case 'za':     return (b.title||'').localeCompare(a.title||'');
      default: return 0;
    }
  });

  return rows;
}

function paginate(rows){
  const start = (state.page-1)*state.perPage;
  const end   = start + state.perPage;
  const totalPages = Math.max(1, Math.ceil(rows.length / state.perPage));
  return { slice: rows.slice(start,end), total: rows.length, totalPages };
}

/******** Render ********/
function render(){
  const all = applyFilters();
  const {slice, total, totalPages} = paginate(all);

  const resultCountEl = $('#resultCount');
  if (resultCountEl) {
    resultCountEl.textContent = (total === 0)
      ? 'No items match your filters'
      : `${total} item${total!==1?'s':''}`;
  }

  const pageInfoEl = $('#pageInfo');
  if (pageInfoEl) pageInfoEl.textContent = `Page ${state.page} of ${totalPages}`;

  $('#skeleton')?.classList.add('hidden');

  const grid = $('#grid');
  if (grid){
    grid.classList.remove('hidden');
    grid.innerHTML = slice.length
      ? slice.map(itemCard).join('')
      : `<div class="col-12"><div class="alert alert-warning mb-0">
           No results. Try clearing filters or check that <code>data/multimedia.json</code> is reachable.
         </div></div>`;
  }

  // Bind bookmark & transcript toggles
  $$('[data-bm]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const entry = {
        id: btn.getAttribute('data-bm'),
        label: btn.getAttribute('data-label') || 'Item',
        href: btn.getAttribute('data-href') || '#'
      };
      NSN.toggleBookmark(entry, '#bookmarkList');
      $$(`[data-bm="${entry.id}"]`).forEach(b=>b.classList.toggle('bookmark-active'));
    });
  });
  $$('[data-tx]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-tx');
      const el = $(`#tx-${CSS.escape(id)}`);
      if(el){ el.classList.toggle('hidden'); }
    });
  });

  // Pager buttons
  const prev = $('#prevPage'), next = $('#nextPage');
  if (prev) prev.disabled = state.page<=1;
  if (next) next.disabled = state.page>=totalPages;

  // Debug counts
  console.log('Render → total:', total, 'page:', state.page, 'slice:', slice.length, 'filters:', {...state});
}

/******** UI wiring ********/
function wire(){
  $('#search')?.addEventListener('input', e=>{ state.q=e.target.value; state.page=1; render(); });
  $('#userTypeFilter')?.addEventListener('change', e=>{ state.ut=e.target.value; state.page=1; render(); });
  $('#categoryFilter')?.addEventListener('change', e=>{ state.cat=e.target.value; state.page=1; render(); });
  $('#formatFilter')?.addEventListener('change', e=>{ state.fmt=e.target.value; state.page=1; render(); });
  $('#sortBy')?.addEventListener('change', e=>{ state.sort=e.target.value; render(); });
  $('#perPage')?.addEventListener('change', e=>{ state.perPage=Number(e.target.value)||9; state.page=1; render(); });

  $('#prevPage')?.addEventListener('click', ()=>{ state.page=Math.max(1, state.page-1); render(); });
  $('#nextPage')?.addEventListener('click', ()=>{ state.page=state.page+1; render(); });

  $('#btnClear')?.addEventListener('click', ()=>{
    state.q=''; state.ut=''; state.cat=''; state.fmt=''; state.sort='newest'; state.page=1; state.perPage=9;
    if($('#search'))           $('#search').value='';
    if($('#userTypeFilter'))   $('#userTypeFilter').value='';
    if($('#categoryFilter'))   $('#categoryFilter').value='';
    if($('#formatFilter'))     $('#formatFilter').value='';
    if($('#sortBy'))           $('#sortBy').value='newest';
    if($('#perPage'))          $('#perPage').value='9';
    render();
  });

  // Shared sidebar actions
  $('#exportBookmarks')?.addEventListener('click', ()=>NSN.exportBookmarks('Bookmarks.txt'));
  $('#clearBookmarks')?.addEventListener('click', ()=>NSN.clearBookmarks('#bookmarkList'));
}

/******** Init ********/
async function init(){
  NSN.utils.setYear('#year');
  paintHeaderProfile();

  // Shared sidebars
  NSN.getRecent();                 // sanitize any old/bad data
  NSN.paintRecent('#recentList');
  NSN.paintBookmarks('#bookmarkList');

  try{
    const raw = await NSN.loadJSON(DATA_URL, { fallback: [], onErrorMessageSelector:'#resultCount' });
    ITEMS = normalizeItems(Array.isArray(raw) ? raw : []);
  } catch(err){
    console.error(err);
    alert(err.message || `Failed to load ${DATA_URL}. Make sure you’re running a local server.`);
    return;
  }

  // Align JS state with currently visible filter selects before first render
  state.ut      = $('#userTypeFilter')?.value || '';
  state.cat     = $('#categoryFilter')?.value || '';
  state.fmt     = $('#formatFilter')?.value || '';
  state.perPage = Number($('#perPage')?.value) || 9;
  state.sort    = $('#sortBy')?.value || 'newest';

  wire();
  render();

  // If nothing shows on first render, auto-clear filters once to unstick accidental prefill
  if (!applyFilters().length) {
    console.warn('No results after first render; auto-clearing filters once.');
    $('#btnClear')?.click();
  }

  NSN.pushRecent('Opened Multimedia', 'multimedia.html', '#recentList');

  // Quick diagnostics bubble (auto-removes)
  (async function diagnostics(){
    const el = document.createElement('div');
    el.style.cssText = "position:fixed;bottom:12px;left:12px;z-index:9999;background:#111;color:#fff;padding:8px 12px;border-radius:8px;font:12px/1.4 system-ui;opacity:.9";
    el.textContent = "Diagnostics: running…";
    document.body.appendChild(el);
    try {
      const res = await fetch(DATA_URL, {cache:'no-store'});
      el.textContent = `Diagnostics: ${res.ok ? 'OK' : 'FAIL'} (status ${res.status})`;
      const text = await res.text();
      console.log('[diagnostics] raw multimedia.json:', text);
      try {
        const json = JSON.parse(text);
        el.textContent += ` • parsed ${Array.isArray(json) ? json.length : 'n/a'} items`;
      } catch (e) {
        el.textContent += ' • JSON parse error (see console)';
        console.error('[diagnostics] JSON parse error:', e);
      }
    } catch (e) {
      el.textContent = 'Diagnostics: fetch threw (see console)';
      console.error('[diagnostics] fetch error:', e);
    }
    setTimeout(()=>el.remove(), 6000);
  })();
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
