<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admissions & Coaching — NextStep Navigator</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <style>
    :root{
      --brand:#5b7cff; --brand2:#0ea5e9; --ink:#0f172a; --muted:#667085; --ring:#e5e7eb; --card:#fff; --surface:#f8fafc;
    }
    html,body{ background:var(--surface); color:var(--ink) }
    a{text-decoration:none}

    .navbar{ background:#fff }
    .brand-dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .page-head{background:#fff;border-bottom:1px solid #eef2f7}
    .lead-muted{color:var(--muted)}
    .muted{color:var(--muted)}
    .panel{background:#fff;border:1px solid var(--ring);border-radius:18px}
    .feature-card{border:1px solid var(--ring);background:var(--card);border-radius:16px;transition:all .25s ease}
    .feature-card:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(16,24,40,.07);border-color:rgba(91,124,255,.4)}
    .chip{display:inline-flex;gap:.4rem;align-items:center;border:1px solid var(--ring);border-radius:999px;padding:.25rem .6rem;background:#fff;font-size:.8rem}
    .icon-pill{width:40px;height:40px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#eef2ff;color:#3b82f6}
    .bookmark-active{color:#e11d48 !important}
    .hidden{display:none !important}
    .thumb{position:relative;aspect-ratio:4/3;background:#e5e7eb;border-radius:12px;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .result-skel{height:200px;border:1px dashed #e5e7eb;border-radius:16px;animation:pulse 1.2s ease-in-out infinite;background:linear-gradient(90deg,#fff 25%,#f4f6f8 37%,#fff 63%)}
    @keyframes pulse{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}
    .step{display:flex;align-items:flex-start;gap:.75rem}
    .step .count{flex:0 0 32px;height:32px;border-radius:10px;background:#eef2ff;color:#3b82f6;display:flex;align-items:center;justify-content:center;font-weight:600}
    .kbd{padding:.15rem .35rem;border:1px solid #e5e7eb;border-bottom-width:2px;border-radius:6px;background:#fff;font-variant-numeric:tabular-nums}
    .note{background:#f8fafc;border:1px dashed #e5e7eb;border-radius:12px}
    .pill{display:inline-flex;gap:.5rem;align-items:center;border:1px solid var(--ring);border-radius:999px;padding:.25rem .6rem;background:#fff;font-size:.8rem}
    .list-mini li+li{border-top:1px dashed #e5e7eb}
    .list-mini li{padding:.4rem 0}
    .anchor-offset{scroll-margin-top: 84px;}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg border-bottom sticky-top">
    <div class="container py-2">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="index.html">
        <span class="brand-dot"></span> NextStep <span class="text-primary">Navigator</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="small text-muted" id="helloUser"></span>
        <a class="btn btn-outline-secondary btn-sm" href="index.html"><i class="bi bi-house me-1"></i> Home</a>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="page-head py-4">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Admissions &amp; Coaching</li>
        </ol>
      </nav>
      <div class="d-flex flex-column flex-md-row align-items-md-end align-items-start justify-content-between gap-3">
        <div>
          <h1 class="mb-1">Admissions &amp; Coaching</h1>
          <p class="lead lead-muted mb-0">Structured guidance for streams, study-abroad, interview prep, and resume crafting — all static and privacy-friendly.</p>
        </div>
        <span class="pill"><i class="bi bi-shield-check"></i> No storage • JSON-driven</span>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="py-4">
    <div class="container">
      <div class="row g-4">
        <!-- LEFT: Filters + sidebars -->
        <aside class="col-lg-3">
          <div class="panel p-3">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0">Personalize</h6>
              <button class="btn btn-link btn-sm" id="btnClearFilters" type="button">Clear</button>
            </div>
            <hr class="my-2"/>

            <div class="mb-3">
              <label class="form-label mb-1" for="userTypeFilter">User Type</label>
              <select id="userTypeFilter" class="form-select">
                <option value="">All</option>
                <option value="student">Student (8–12)</option>
                <option value="graduate">Graduate (UG/PG)</option>
                <option value="professional">Professional</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label mb-1" for="search">Search Topics</label>
              <input type="search" id="search" class="form-control" placeholder="Streams, visas, STAR, ATS…"/>
            </div>

            <div class="mb-0">
              <label class="form-label mb-1" for="sortBy">Sort sections</label>
              <select id="sortBy" class="form-select">
                <option value="default" selected>Recommended</option>
                <option value="az">Title A → Z</option>
                <option value="za">Title Z → A</option>
              </select>
            </div>
          </div>

          <div class="panel p-3 mt-3">
            <h6>Quick Links</h6>
            <ul class="list-unstyled list-mini mb-0">
              <li><a href="#stream" class="anchor">Stream Selection (post-10th)</a></li>
              <li><a href="#abroad" class="anchor">Study Abroad</a></li>
              <li><a href="#interview" class="anchor">Interview Tips</a></li>
              <li><a href="#resume" class="anchor">Resume Guidelines</a></li>
            </ul>
          </div>

          <div class="panel p-3 mt-3">
            <h6>Recently Viewed</h6>
            <ul id="recentList" class="list-unstyled small mb-0">
              <li class="text-muted">Nothing yet.</li>
            </ul>
          </div>

          <div class="panel p-3 mt-3">
            <h6>Your Bookmarks</h6>
            <ul id="bookmarkList" class="list-unstyled small mb-2">
              <li class="text-muted">No bookmarks yet.</li>
            </ul>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" id="exportBookmarks" type="button">
                <i class="bi bi-arrow-down-square me-1"></i> Export
              </button>
              <button class="btn btn-outline-danger btn-sm" id="clearBookmarks" type="button">
                <i class="bi bi-trash3 me-1"></i> Clear
              </button>
            </div>
          </div>
        </aside>

        <!-- RIGHT: Sections -->
        <section class="col-lg-9">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="small text-muted" id="activeProfile"></div>
            <div class="small text-muted"><span id="resultInfo">Loading…</span></div>
          </div>

          <!-- STREAM SELECTION -->
          <section id="stream" class="anchor-offset">
            <div class="panel p-3 p-md-4">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h4 class="mb-0">Stream Selection (post-10th)</h4>
                <div class="d-flex gap-2">
                  <button class="btn btn-light btn-sm" id="shareStream" type="button">
                    <i class="bi bi-share me-1"></i> Share
                  </button>
                </div>
              </div>
              <p class="muted mt-2 mb-3">Align your strengths with the right stream. Explore subjects, sample careers, and admission tips. Loaded from <code>data/admissions.json</code>.</p>

              <div id="streamGrid" class="row g-3">
                <div class="col-12 col-md-6 col-xl-4"><div class="result-skel"></div></div>
                <div class="col-12 col-md-6 col-xl-4"><div class="result-skel"></div></div>
                <div class="col-12 col-md-6 col-xl-4"><div class="result-skel"></div></div>
              </div>
            </div>
          </section>

          <!-- STUDY ABROAD -->
          <section id="abroad" class="anchor-offset mt-4">
            <div class="panel p-3 p-md-4">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h4 class="mb-0">Study Abroad Guidelines</h4>
                <div class="d-flex gap-2">
                  <button class="btn btn-light btn-sm" id="shareAbroad" type="button"><i class="bi bi-share me-1"></i> Share</button>
                </div>
              </div>
              <p class="muted mt-2 mb-3">A month-by-month plan, documents checklist, tests, and scholarship pointers — tailored by user type where applicable.</p>

              <div id="abroadTimeline" class="vstack gap-3">
                <div class="result-skel"></div>
              </div>

              <div class="note p-3 mt-3">
                <div class="d-flex align-items-start gap-2">
                  <i class="bi bi-lightbulb"></i>
                  <div class="small">
                    Tip: Always verify country-specific requirements at the official embassy/consulate and the target university’s admissions page.
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- INTERVIEW TIPS -->
          <section id="interview" class="anchor-offset mt-4">
            <div class="panel p-3 p-md-4">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h4 class="mb-0">Interview Tips</h4>
                <div class="d-flex gap-2">
                  <button class="btn btn-light btn-sm" id="shareInterview" type="button"><i class="bi bi-share me-1"></i> Share</button>
                </div>
              </div>
              <p class="muted mt-2 mb-3">From story prep to behavioral questions (STAR), plus recruiter expectations for graduates and career-changers.</p>

              <div class="row g-3" id="interviewCards">
                <div class="col-12 col-md-6"><div class="result-skel"></div></div>
                <div class="col-12 col-md-6"><div class="result-skel"></div></div>
              </div>

              <details class="mt-3">
                <summary class="fw-semibold">STAR formula refresher</summary>
                <div class="mt-2 small">
                  <div class="step mb-2"><span class="count">S</span><div><strong>Situation:</strong> Give brief context.</div></div>
                  <div class="step mb-2"><span class="count">T</span><div><strong>Task:</strong> State the goal or responsibility.</div></div>
                  <div class="step mb-2"><span class="count">A</span><div><strong>Action:</strong> Explain what you did (focus on you).</div></div>
                  <div class="step"><span class="count">R</span><div><strong>Result:</strong> Share the outcome, numbers, and learning.</div></div>
                </div>
              </details>
            </div>
          </section>

          <!-- RESUME GUIDELINES -->
          <section id="resume" class="anchor-offset mt-4">
            <div class="panel p-3 p-md-4">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h4 class="mb-0">Resume Guidelines</h4>
                <div class="d-flex gap-2">
                  <button class="btn btn-light btn-sm" id="shareResume" type="button"><i class="bi bi-share me-1"></i> Share</button>
                </div>
              </div>
              <p class="muted mt-2 mb-3">ATS-friendly structure, bullet phrasing, impact metrics, and samples based on user type.</p>

              <div id="resumeAccordion" class="accordion">
                <!-- injected -->
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn btn-primary btn-sm" id="btnSaveAll"><i class="bi bi-bookmark-heart me-1"></i> Save all visible</button>
                <button class="btn btn-outline-primary btn-sm" id="btnExport"><i class="bi bi-arrow-down-square me-1"></i> Export page notes</button>
              </div>
            </div>
          </section>
        </section>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="py-4 border-top bg-white">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
      <div class="small text-muted">© <span id="year"></span> NextStep Navigator • Admissions & Coaching</div>
      <div class="small"><a href="about.html" class="me-3">About</a><a href="contact.html">Contact</a></div>
    </div>
  </footer>

  <!-- Shared module -->
  <script src="js/nsn-shared.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Page Script -->
  <script>
  (function(){
    "use strict";

    const DATA_URL = "data/admissions.json";

    const $  = NSN.utils.$;
    const $$ = NSN.utils.$$;
    const esc = (s='') => NSN.utils.escapeHTML(s);

    let DATA = {
      streams: [], timeline: [], interviews: [], resume: []
    };

    const state = {
      ut: '',      // user type filter
      q: '',       // search text
      sort: 'default'
    };

    /* ---------------- Personalization header ---------------- */
    function paintHeader(){
      NSN.paintHeaderProfile('#helloUser', '#activeProfile', '#userTypeFilter');
    }

    /* ---------------- Utility: copy text ---------------- */
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        alert("Copied to clipboard.");
      }catch(e){
        console.warn("Clipboard failed", e);
        const ta=document.createElement('textarea');
        ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        alert("Copied to clipboard.");
      }
    }

    /* ---------------- Filters wiring ---------------- */
    function wireFilters(){
      $('#userTypeFilter')?.addEventListener('change', e=>{
        state.ut = e.target.value || '';
        renderAll();
      });
      $('#search')?.addEventListener('input', e=>{
        state.q = (e.target.value||'').toLowerCase();
        renderAll();
      });
      $('#sortBy')?.addEventListener('change', e=>{
        state.sort = e.target.value || 'default';
        renderAll();
      });
      $('#btnClearFilters')?.addEventListener('click', ()=>{
        state.ut=''; state.q=''; state.sort='default';
        if ($('#userTypeFilter')) $('#userTypeFilter').value='';
        if ($('#search')) $('#search').value='';
        if ($('#sortBy')) $('#sortBy').value='default';
        renderAll();
      });

      // quick anchors with nice scroll + recent tracking
      $$('.anchor').forEach(a=>{
        a.addEventListener('click', (e)=>{
          NSN.pushRecent(a.textContent.trim(), a.getAttribute('href') || 'admissions.html', '#recentList');
        });
      });
    }

    /* ---------------- STREAMS ---------------- */
    function cardStream(s){
      const bmActive = NSN.isBookmarked(s.id) ? 'bookmark-active' : '';
      const subj = (s.subjects||[]).map(x=>`<span class="chip"><i class="bi bi-journal-code"></i> ${esc(x)}</span>`).join(' ');
      const tags = (s.tags||[]).map(x=>`<span class="chip"><i class="bi bi-tag"></i> ${esc(x)}</span>`).join(' ');
      const careers = (s.sampleCareers||[]).slice(0,3).map(c=>esc(c)).join(', ');
      return `
        <div class="col-12 col-md-6 col-xl-4">
          <article class="feature-card p-3 h-100 d-flex flex-column">
            <div class="d-flex align-items-start justify-content-between">
              <div class="icon-pill"><i class="bi ${s.icon||'bi-mortarboard'}"></i></div>
              <button class="btn btn-light btn-sm border-0 ${bmActive}" title="Bookmark"
                      data-bm="${s.id}" data-label="${esc(s.title)}" data-href="admissions.html#stream">
                <i class="bi bi-heart-fill"></i>
              </button>
            </div>
            <h6 class="mt-2 mb-1">${esc(s.title)}</h6>
            <div class="small muted mb-2">${esc(s.description||'')}</div>
            <div class="d-flex flex-wrap gap-1 mb-2">${subj}</div>
            <div class="small mb-2"><i class="bi bi-briefcase me-1"></i><strong>Careers:</strong> ${careers||'—'}</div>
            <div class="d-flex flex-wrap gap-1">${tags}</div>
            <div class="mt-auto d-flex flex-wrap gap-2 pt-2">
              <a class="btn btn-outline-primary btn-sm" href="careers.html?industry=${encodeURIComponent(s.careerIndustry||'')}" target="_self">
                <i class="bi bi-briefcase me-1"></i> Open Career Bank
              </a>
              ${s.checklistUrl ? `<a class="btn btn-light btn-sm" href="${esc(s.checklistUrl)}" target="_blank" rel="noreferrer"><i class="bi bi-download me-1"></i> Checklist</a>`:''}
            </div>
          </article>
        </div>
      `;
    }

    function renderStreams(){
      const grid = $('#streamGrid');
      if(!grid) return;

      let rows = DATA.streams || [];
      if (state.ut) rows = rows.filter(x => !x.userType || x.userType===state.ut);
      if (state.q){
        rows = rows.filter(x=>{
          const hay = `${x.title} ${x.description} ${(x.subjects||[]).join(' ')} ${(x.tags||[]).join(' ')} ${(x.sampleCareers||[]).join(' ')}`.toLowerCase();
          return hay.includes(state.q);
        });
      }
      if (state.sort==='az') rows.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
      if (state.sort==='za') rows.sort((a,b)=>(b.title||'').localeCompare(a.title||''));

      if (!rows.length){
        grid.innerHTML = `<div class="col-12"><div class="alert alert-warning mb-0">No streams match your filters.</div></div>`;
        return;
      }
      grid.innerHTML = rows.map(cardStream).join('');

      $$('[data-bm]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.preventDefault();
          NSN.toggleBookmark({
            id: btn.getAttribute('data-bm'),
            label: btn.getAttribute('data-label')||'Stream',
            href:  btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${btn.getAttribute('data-bm')}"]`).forEach(b=>b.classList.toggle('bookmark-active'));
        });
      });
    }

    /* ---------------- ABROAD TIMELINE ---------------- */
    function rowTimeline(t, idx){
      const bmId = `abroad-${idx}`;
      const bmActive = NSN.isBookmarked(bmId) ? 'bookmark-active' : '';
      const docs = (t.documents||[]).map(d=>`<span class="chip"><i class="bi bi-file-earmark-text"></i> ${esc(d)}</span>`).join(' ');
      return `
        <div class="feature-card p-3">
          <div class="d-flex align-items-start justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <div class="count">${idx+1}</div>
              <h6 class="mb-0">${esc(t.title)}</h6>
            </div>
            <button class="btn btn-light btn-sm border-0 ${bmActive}" title="Bookmark"
                    data-bm="${bmId}" data-label="${esc(t.title)}" data-href="admissions.html#abroad">
              <i class="bi bi-heart-fill"></i>
            </button>
          </div>
          <div class="small muted mt-2 mb-2">${esc(t.subtitle||'')}</div>
          <ul class="mb-2">
            ${(t.actions||[]).map(a=>`<li>${esc(a)}</li>`).join('')}
          </ul>
          ${docs ? `<div class="d-flex flex-wrap gap-1">${docs}</div>`:''}
        </div>
      `;
    }

    function renderAbroad(){
      const box = $('#abroadTimeline');
      if(!box) return;

      let rows = DATA.timeline || [];
      if (state.ut) rows = rows.filter(x => !x.userType || x.userType===state.ut);
      if (state.q){
        rows = rows.filter(x=>{
          const hay = `${x.title} ${x.subtitle} ${(x.actions||[]).join(' ')} ${(x.documents||[]).join(' ')}`.toLowerCase();
          return hay.includes(state.q);
        });
      }

      if (!rows.length){
        box.innerHTML = `<div class="alert alert-warning mb-0">No timeline items match your filters.</div>`;
        return;
      }
      box.innerHTML = rows.map(rowTimeline).join('');

      $$('[data-bm]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          NSN.toggleBookmark({
            id: btn.getAttribute('data-bm'),
            label: btn.getAttribute('data-label')||'Abroad step',
            href:  btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${btn.getAttribute('data-bm')}"]`).forEach(b=>b.classList.toggle('bookmark-active'));
        });
      });
    }

    /* ---------------- INTERVIEW ---------------- */
    function cardInterview(iv, idx){
      const id = iv.id || `iv-${idx}`;
      const bmActive = NSN.isBookmarked(id) ? 'bookmark-active' : '';
      const tips = (iv.tips||[]).map(t=>`<li>${esc(t)}</li>`).join('');
      const qas = (iv.qas||[]).map(q=>`
        <li class="mb-1">
          <strong>${esc(q.q)}</strong>
          <div class="small muted">Hint: ${esc(q.hint||'Think STAR')}</div>
          <div class="small">Sample: ${esc(q.sample||'')}</div>
        </li>`).join('');
      const tags = (iv.tags||[]).map(t=>`<span class="chip"><i class="bi bi-tag"></i> ${esc(t)}</span>`).join(' ');
      return `
        <div class="col-12 col-md-6">
          <article class="feature-card p-3 h-100 d-flex flex-column">
            <div class="d-flex align-items-start justify-content-between">
              <div class="icon-pill"><i class="bi ${iv.icon||'bi-chat-square-quote'}"></i></div>
              <button class="btn btn-light btn-sm border-0 ${bmActive}" title="Bookmark"
                      data-bm="${id}" data-label="${esc(iv.title)}" data-href="admissions.html#interview">
                <i class="bi bi-heart-fill"></i>
              </button>
            </div>
            <h6 class="mt-2 mb-1">${esc(iv.title)}</h6>
            <div class="small muted mb-2">${esc(iv.subtitle||'')}</div>
            ${tags?`<div class="d-flex flex-wrap gap-1 mb-2">${tags}</div>`:''}
            ${tips?`<h6 class="mt-2">Tips</h6><ul class="mb-2">${tips}</ul>`:''}
            ${qas?`<h6 class="mt-1">Common questions</h6><ol class="mb-0">${qas}</ol>`:''}
          </article>
        </div>
      `;
    }

    function renderInterview(){
      const grid = $('#interviewCards');
      if(!grid) return;

      let rows = DATA.interviews || [];
      if (state.ut) rows = rows.filter(x => !x.userType || x.userType===state.ut);
      if (state.q){
        rows = rows.filter(x=>{
          const hay = `${x.title} ${x.subtitle} ${(x.tips||[]).join(' ')} ${(x.tags||[]).join(' ')} ${(x.qas||[]).map(q=>q.q+' '+q.sample+' '+q.hint).join(' ')}`.toLowerCase();
          return hay.includes(state.q);
        });
      }
      if (state.sort==='az') rows.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); 
      if (state.sort==='za') rows.sort((a,b)=>(b.title||'').localeCompare(a.title||''));

      if (!rows.length){
        grid.innerHTML = `<div class="col-12"><div class="alert alert-warning mb-0">No interview items match your filters.</div></div>`;
        return;
      }
      grid.innerHTML = rows.map(cardInterview).join('');

      $$('[data-bm]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          NSN.toggleBookmark({
            id: btn.getAttribute('data-bm'),
            label: btn.getAttribute('data-label')||'Interview',
            href:  btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${btn.getAttribute('data-bm')}"]`).forEach(b=>b.classList.toggle('bookmark-active'));
        });
      });
    }

    /* ---------------- RESUME ---------------- */
    function sectionResume(r, idx){
      const id = r.id || `resume-${idx}`;
      const bmActive = NSN.isBookmarked(id) ? 'bookmark-active' : '';
      const dos = (r.dos||[]).map(x=>`<li>${esc(x)}</li>`).join('');
      const donts = (r.donts||[]).map(x=>`<li>${esc(x)}</li>`).join('');
      const ex = (r.examples||[]).map(e=>`
        <div class="p-2 border rounded-3 mb-2 small bg-white">
          <div class="fw-semibold">${esc(e.heading||'Example')}</div>
          <div>${esc(e.text||'')}</div>
        </div>`).join('');
      return `
        <div class="accordion-item">
          <h2 class="accordion-header" id="h-${id}">
            <button class="accordion-button ${idx? 'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#c-${id}" aria-expanded="${idx? 'false':'true'}" aria-controls="c-${id}">
              ${esc(r.title)}
            </button>
          </h2>
          <div id="c-${id}" class="accordion-collapse collapse ${idx? '':'show'}" aria-labelledby="h-${id}">
            <div class="accordion-body">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <div class="small muted">${esc(r.subtitle||'')}</div>
                <button class="btn btn-light btn-sm border-0 ${bmActive}" title="Bookmark"
                        data-bm="${id}" data-label="${esc(r.title)}" data-href="admissions.html#resume">
                  <i class="bi bi-heart-fill"></i>
                </button>
              </div>
              ${r.summary? `<p class="mb-2">${esc(r.summary)}</p>`: ''}
              <div class="row g-3">
                <div class="col-md-6">
                  ${dos? `<h6>Do</h6><ul class="mb-2">${dos}</ul>`:''}
                </div>
                <div class="col-md-6">
                  ${donts? `<h6>Don't</h6><ul class="mb-2">${donts}</ul>`:''}
                </div>
              </div>
              ${ex? `<h6 class="mt-2">Examples</h6>${ex}`:''}
            </div>
          </div>
        </div>
      `;
    }

    function renderResume(){
      const acc = $('#resumeAccordion');
      if(!acc) return;

      let rows = DATA.resume || [];
      if (state.ut) rows = rows.filter(x => !x.userType || x.userType===state.ut);
      if (state.q){
        rows = rows.filter(x=>{
          const hay = `${x.title} ${x.subtitle} ${x.summary} ${(x.dos||[]).join(' ')} ${(x.donts||[]).join(' ')} ${(x.examples||[]).map(e=>e.heading+' '+e.text).join(' ')}`.toLowerCase();
          return hay.includes(state.q);
        });
      }
      if (state.sort==='az') rows.sort((a,b)=>(a.title||'').localeCompare(b.title||'')); 
      if (state.sort==='za') rows.sort((a,b)=>(b.title||'').localeCompare(a.title||''));

      if (!rows.length){
        acc.innerHTML = `<div class="p-3"><div class="alert alert-warning mb-0">No resume sections match your filters.</div></div>`;
        return;
      }
      acc.innerHTML = rows.map(sectionResume).join('');

      $$('[data-bm]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          NSN.toggleBookmark({
            id: btn.getAttribute('data-bm'),
            label: btn.getAttribute('data-label')||'Resume',
            href:  btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${btn.getAttribute('data-bm')}"]`).forEach(b=>b.classList.toggle('bookmark-active'));
        });
      });
    }

    /* ---------------- SHARE BUTTONS ---------------- */
    function wireShareButtons(){
      function tryShare(title, urlHash){
        const url = location.origin ? (location.origin + location.pathname + urlHash) : (location.href.split('#')[0] + urlHash);
        const text = `${title} — NextStep Navigator\n${url}`;
        if (navigator.share){
          navigator.share({ title, text, url }).catch(()=>{ /* user canceled */ });
        } else {
          copyText(text);
        }
      }
      $('#shareStream')?.addEventListener('click', ()=>tryShare('Stream Selection', '#stream'));
      $('#shareAbroad')?.addEventListener('click', ()=>tryShare('Study Abroad Guidelines', '#abroad'));
      $('#shareInterview')?.addEventListener('click', ()=>tryShare('Interview Tips', '#interview'));
      $('#shareResume')?.addEventListener('click', ()=>tryShare('Resume Guidelines', '#resume'));
    }

    /* ---------------- Bulk save & export ---------------- */
    function wireActions(){
      $('#btnSaveAll')?.addEventListener('click', ()=>{
        // save currently visible section headings into bookmarks
        // stream cards
        $$('#streamGrid [data-bm]').forEach(btn=>{
          const id = btn.getAttribute('data-bm');
          NSN.toggleBookmark({
            id, label: btn.getAttribute('data-label')||'Item', href: btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${id}"]`).forEach(b=>b.classList.add('bookmark-active'));
        });
        // abroad items
        $$('#abroadTimeline [data-bm]').forEach(btn=>{
          const id = btn.getAttribute('data-bm');
          NSN.toggleBookmark({
            id, label: btn.getAttribute('data-label')||'Item', href: btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${id}"]`).forEach(b=>b.classList.add('bookmark-active'));
        });
        // resume sections
        $$('#resumeAccordion [data-bm]').forEach(btn=>{
          const id = btn.getAttribute('data-bm');
          NSN.toggleBookmark({
            id, label: btn.getAttribute('data-label')||'Item', href: btn.getAttribute('data-href')||'#'
          }, '#bookmarkList');
          $$(`[data-bm="${id}"]`).forEach(b=>b.classList.add('bookmark-active'));
        });
        alert('Saved all visible sections to Bookmarks.');
      });

      $('#btnExport')?.addEventListener('click', ()=>{
        const lines = [];
        lines.push('NextStep Navigator — Admissions & Coaching');
        lines.push(`User type filter: ${state.ut || 'All'}`);
        lines.push('');
        lines.push('[Stream Selection]');
        $$('#streamGrid h6').forEach(h=>lines.push('- ' + h.textContent.trim()));
        lines.push('');
        lines.push('[Study Abroad Steps]');
        $$('#abroadTimeline .feature-card h6').forEach(h=>lines.push('- ' + h.textContent.trim()));
        lines.push('');
        lines.push('[Resume Sections]');
        $$('#resumeAccordion .accordion-button').forEach(b=>lines.push('- ' + b.textContent.trim()));
        const blob = new Blob([lines.join('\n')], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'Admissions_Notes.txt'; a.click();
        URL.revokeObjectURL(url);
      });

      $('#exportBookmarks')?.addEventListener('click', ()=>NSN.exportBookmarks('Admissions_Bookmarks.txt'));
      $('#clearBookmarks')?.addEventListener('click', ()=>NSN.clearBookmarks('#bookmarkList'));
    }

    /* ---------------- Render all ---------------- */
    function renderAll(){
      renderStreams();
      renderAbroad();
      renderInterview();
      renderResume();

      const total =
        $$('#streamGrid [data-bm]').length +
        $$('#abroadTimeline [data-bm]').length +
        $$('#interviewCards [data-bm]').length +
        $$('#resumeAccordion [data-bm]').length;

      const info = $('#resultInfo');
      if (info) info.textContent = total ? `Showing ${total} actionable items` : 'No items';
    }

    /* ---------------- Init ---------------- */
    async function init(){
      NSN.utils.setYear('#year');
      paintHeader();

      // sidebars
      NSN.getRecent();       // sanitize any old data
      NSN.paintRecent('#recentList');
      NSN.paintBookmarks('#bookmarkList');

      try{
        const raw = await NSN.loadJSON(DATA_URL, { fallback:null, onErrorMessageSelector:'#resultInfo' });
        DATA = Object.assign({streams:[], timeline:[], interviews:[], resume:[]}, raw || {});
      }catch(e){
        console.error(e);
        alert('Failed to load admissions.json. Ensure you are serving over http(s) and the path is correct.');
        return;
      }

      wireFilters();
      wireShareButtons();
      wireActions();

      renderAll();

      NSN.pushRecent('Opened Admissions & Coaching', 'admissions.html', '#recentList');

      // hash deep link
      if (location.hash) {
        const id = location.hash;
        const el = document.querySelector(id);
        if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
